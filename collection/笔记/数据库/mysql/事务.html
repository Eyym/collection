<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>事务</title>
    <link rel="stylesheet" type="text/css" href="/collection/css/common.css">
    <link rel="stylesheet" type="text/css" href="/collection/css/Syntaxhighlighter/shCoreMDUltra.css"/>
    <script src="/collection/js/common.js"></script>
</head>
<body>
<aside></aside>
<article>
    <header>
        <h1>事务</h1>
        <div id="info">
            <div id="time">2019-06-23</div>
            <div id="author">作者：<span><a href="javascript:myAlert();">loubth</a></span></div>
        </div>
    </header>
    <div class="content doc">

        <h2>事务安全</h2>
        <h3>事务概念</h3>
        <p>事务（Transaction）是访问并可能更新数据库中各种数据项的一个程序执行单元（unit）。事务通常由高级数据库操纵语言或编程语言书写的用户程序的执行所引起。事务由事务开始（begin transaction）和事务结束（end transaction）之间执行的全体操作组成</p>
        <p>我觉得通俗的说就是<em>若干条SQL指令（写操作：增删改）组成的一个整体</em>叫事务</p>
        <p>事务应该具有4个属性：原子性、一致性、隔离性、持久性。这四个属性通常称为ACID特性</p>
        <ul>
            <li>原子性（atomicity）。一个事务是一个不可分割的工作单位，事务中包括的诸操作要么都做，要么都不做</li>
            <li>一致性（consistency）。事务必须是使数据库从一个一致性状态变到另一个一致性状态。一致性与原子性是密切相关的</li>
            <li> 隔离性（isolation）。一个事务的执行不能被其他事务干扰。即一个事务内部的操作及使用的数据对并发的其他事务是隔离的，并发执行的各个事务之间不能互相干扰。比如说两个客户端操纵同一条数据的时候，其中一条会等待另一条执行完毕才能执行</li>
            <li>持久性（durability）。持续性也称永久性（permanence），指一个事务一旦提交，它对数据库中数据的改变就应该是永久性的。接下来的其他操作或故障不应该对其有任何影响</li>
        </ul>
        <p><em>原子性和一致性的区别</em>：一致性强调从实际的业务逻辑上来说，最终结果是对的、是跟程序员的所期望的结果完全符合的。原子性并不能完全保证一致性。在多个事务并行进行的情况下，即使保证了每一个事务的原子性，仍然可能导致数据不一致的结果。例如，事务1需要将100元转入帐号A：先读取帐号A的值，然后在这个值上加上100。但是，在这两个操作之间，另一个事务2修改了帐号A的值，为它增加了100元。那么最后的结果应该是A增加了200元。但事实上，事务1最终完成后，帐号A只增加了100元，因为事务2的修改结果被事务1覆盖掉了</p>
        <p><em>什么时候是行被隔离？什么时候是正表被隔离？</em>说明：如果条件中使用了索引（主键），那么系统是根据主键直接找到某条记录，这个时候与其他记录无关，那么只隔离一条记录；反之，如果说系统是通过全表检索（每一条记录都去检查：没有索引），被检索的所有数据都会被锁定（整表）隔离</p>
        <h3>事务基本原理</h3>
        <p><em>基本原理</em>：mysql允许将事务统一进行管理（存储引擎innodb），将用户所做的操作，暂时保存起来，不直接放到数据表（更新），等到用于确认结果之后再进行操作</p>
        <div style="height: 330px;overflow-x:scroll ;"><img src="/collection/image/2019/6/20190623_1.png" style="max-width: 1500px;" alt=""></div>
        <p>事务在mysql中通常是自动提交的，但是也可以使用手动事务</p>
        <hr>
        <h2>自动事务</h2>
        <p>自动事务：auto commit，当客户端发送一条SQL指令（写操作：增删改）给服务器的时候，服务器在执行之后，不用等待用户反馈结果，会自动将结果同步到数据表</p>


        <p>mysql是通过“autocommit”系统变量来控制自动提交事务的，我们使用“show variables like 'autocommit'”指令查看一下这个变量</p>
        <div id="highlighter_492796" class="syntaxhighlighter  xml"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="xml plain">mysql&gt;&nbsp;show&nbsp;variables&nbsp;like&nbsp;'autocommit';</code></div><div class="line number2 index1 alt1"><code class="xml plain">+---------------+-------+</code></div><div class="line number3 index2 alt2"><code class="xml plain">|&nbsp;Variable_name&nbsp;|&nbsp;Value&nbsp;|</code></div><div class="line number4 index3 alt1"><code class="xml plain">+---------------+-------+</code></div><div class="line number5 index4 alt2"><code class="xml plain">|&nbsp;autocommit&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;ON&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number6 index5 alt1"><code class="xml plain">+---------------+-------+</code></div><div class="line number7 index6 alt2"><code class="xml plain">1&nbsp;row&nbsp;in&nbsp;set,&nbsp;9&nbsp;warnings&nbsp;(0.00&nbsp;sec)</code></div></div></td></tr></tbody></table>
        </div>
        <p>可以看到系统默认使用自动事务，这可以保证我们发送的每条SQL指令都会立即从事务操作日志中同步到数据库的表中，下面我们来证明一下</p>
        <p>证明：利用两个客户端，一个客户端执行SQL指令（客户端1），另外一个客户端查看执行结果（客户端2）</p>


        <p>原始“my_class”表</p>
        <div id="highlighter_522435" class="syntaxhighlighter  xml"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="xml plain">mysql&gt;&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;my_class;</code></div><div class="line number2 index1 alt1"><code class="xml plain">+----------+------------+</code></div><div class="line number3 index2 alt2"><code class="xml plain">|&nbsp;class_id&nbsp;|&nbsp;class_name&nbsp;|</code></div><div class="line number4 index3 alt1"><code class="xml plain">+----------+------------+</code></div><div class="line number5 index4 alt2"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;|&nbsp;1班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number6 index5 alt1"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;|&nbsp;2班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number7 index6 alt2"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3&nbsp;|&nbsp;3班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number8 index7 alt1"><code class="xml plain">+----------+------------+</code></div><div class="line number9 index8 alt2"><code class="xml plain">3&nbsp;rows&nbsp;in&nbsp;set&nbsp;(0.02&nbsp;sec)</code></div></div></td></tr></tbody></table>
        </div>

        <p>客户端1向这张表中插入一条数据并查看结果</p>
        <div id="highlighter_712912" class="syntaxhighlighter  xml"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="xml plain">mysql&gt;&nbsp;INSERT&nbsp;INTO&nbsp;my_class&nbsp;VALUES(4,'4班');</code></div><div class="line number2 index1 alt1"><code class="xml plain">Query&nbsp;OK,&nbsp;1&nbsp;row&nbsp;affected&nbsp;(0.02&nbsp;sec)</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="xml plain">mysql&gt;&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;my_class;</code></div><div class="line number5 index4 alt2"><code class="xml plain">+----------+------------+</code></div><div class="line number6 index5 alt1"><code class="xml plain">|&nbsp;class_id&nbsp;|&nbsp;class_name&nbsp;|</code></div><div class="line number7 index6 alt2"><code class="xml plain">+----------+------------+</code></div><div class="line number8 index7 alt1"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;|&nbsp;1班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number9 index8 alt2"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;|&nbsp;2班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number10 index9 alt1"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3&nbsp;|&nbsp;3班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number11 index10 alt2"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4&nbsp;|&nbsp;4班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number12 index11 alt1"><code class="xml plain">+----------+------------+</code></div><div class="line number13 index12 alt2"><code class="xml plain">4&nbsp;rows&nbsp;in&nbsp;set&nbsp;(0.00&nbsp;sec)</code></div></div></td></tr></tbody></table>
        </div>
        <p>客户端2查看结果</p>
        <div id="highlighter_93581" class="syntaxhighlighter  xml"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="xml plain">mysql&gt;&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;my_class;</code></div><div class="line number2 index1 alt1"><code class="xml plain">+----------+------------+</code></div><div class="line number3 index2 alt2"><code class="xml plain">|&nbsp;class_id&nbsp;|&nbsp;class_name&nbsp;|</code></div><div class="line number4 index3 alt1"><code class="xml plain">+----------+------------+</code></div><div class="line number5 index4 alt2"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;|&nbsp;1班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number6 index5 alt1"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;|&nbsp;2班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number7 index6 alt2"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3&nbsp;|&nbsp;3班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number8 index7 alt1"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4&nbsp;|&nbsp;4班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number9 index8 alt2"><code class="xml plain">+----------+------------+</code></div><div class="line number10 index9 alt1"><code class="xml plain">4&nbsp;rows&nbsp;in&nbsp;set&nbsp;(0.01&nbsp;sec)</code></div></div></td></tr></tbody></table>
        </div>
        <p>此时我们发现客户端1对数据库进行的操作两个客户端都能查看到操作后的结果，这就证明该SQL指令已经对目标数据库表产生了影响</p>

        <p>那我们关闭了自动事务提交会怎么样呢？来试一下</p>
        <div id="highlighter_99359" class="syntaxhighlighter  xml"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="xml plain">mysql&gt;&nbsp;SET&nbsp;autocommit=OFF;</code></div><div class="line number2 index1 alt1"><code class="xml plain">Query&nbsp;OK,&nbsp;0&nbsp;rows&nbsp;affected&nbsp;(0.00&nbsp;sec)</code></div></div></td></tr></tbody></table>
        </div>

        <p>客户端1再向这张表中插入一条数据</p>
        <div id="highlighter_868232" class="syntaxhighlighter  xml"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="xml plain">mysql&gt;&nbsp;INSERT&nbsp;INTO&nbsp;my_class&nbsp;VALUES(5,'5班');</code></div><div class="line number2 index1 alt1"><code class="xml plain">Query&nbsp;OK,&nbsp;1&nbsp;row&nbsp;affected&nbsp;(0.00&nbsp;sec)</code></div></div></td></tr></tbody></table>
        </div>
        <p>客户端2查看结果</p>
        <div id="highlighter_96427" class="syntaxhighlighter  xml"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="xml plain">mysql&gt;&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;my_class;</code></div><div class="line number2 index1 alt1"><code class="xml plain">+----------+------------+</code></div><div class="line number3 index2 alt2"><code class="xml plain">|&nbsp;class_id&nbsp;|&nbsp;class_name&nbsp;|</code></div><div class="line number4 index3 alt1"><code class="xml plain">+----------+------------+</code></div><div class="line number5 index4 alt2"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;|&nbsp;1班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number6 index5 alt1"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;|&nbsp;2班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number7 index6 alt2"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3&nbsp;|&nbsp;3班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number8 index7 alt1"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4&nbsp;|&nbsp;4班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number9 index8 alt2"><code class="xml plain">+----------+------------+</code></div><div class="line number10 index9 alt1"><code class="xml plain">4&nbsp;rows&nbsp;in&nbsp;set&nbsp;(0.00&nbsp;sec)</code></div></div></td></tr></tbody></table>
        </div>
        <p>此时我们发现客户端2并没有查看到客户端1操作后的结果，这就是因为此时关闭了自动事务提交，所以该条SQL指令只是保存到了事务操作日志中，还没有同步到目标数据库表中，也就是说没有对目标数据库表产生影响，所以客户端2并没有查看到客户端1操作后的结果</p>
        <p>我们使用客户端1查看一下结果</p>
        <div id="highlighter_404388" class="syntaxhighlighter  xml"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="xml plain">mysql&gt;&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;my_class;</code></div><div class="line number2 index1 alt1"><code class="xml plain">+----------+------------+</code></div><div class="line number3 index2 alt2"><code class="xml plain">|&nbsp;class_id&nbsp;|&nbsp;class_name&nbsp;|</code></div><div class="line number4 index3 alt1"><code class="xml plain">+----------+------------+</code></div><div class="line number5 index4 alt2"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;|&nbsp;1班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number6 index5 alt1"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;|&nbsp;2班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number7 index6 alt2"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3&nbsp;|&nbsp;3班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number8 index7 alt1"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4&nbsp;|&nbsp;4班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number9 index8 alt2"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5&nbsp;|&nbsp;5班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number10 index9 alt1"><code class="xml plain">+----------+------------+</code></div><div class="line number11 index10 alt2"><code class="xml plain">5&nbsp;rows&nbsp;in&nbsp;set&nbsp;(0.00&nbsp;sec)</code></div></div></td></tr></tbody></table>
        </div>
        <p>我们发现客户端1竟然能查看到处理后的结果，不是说还没同步到数据库表中么，为什么客户端1能查看到处理后的结果呢？</p>
        <p>这是因为操作是客户端1做的，客户端1查询结果的时候，系统会自动根据日志表中的操作进行数据加工</p>
        <p>我们要是想让客户端2也能查看到操作后的结果呢？这就需要我们手动提交事务了，在客户中使用“commit”指令，即可提交该事务，对目标数据库表产生影响</p>

        <blockquote>
            一旦自动事务关闭，那么需要用户提供是否同步的命令
            <br><br>commit：提交（同步到数据表，操作后事务会被清空）
            <br>rollback：回滚（直接清空事务，之前的操作不要了）
        </blockquote>

        <p>我们用客户端1来提交一下事务</p>
        <div id="highlighter_714600" class="syntaxhighlighter  xml"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="xml plain">mysql&gt;&nbsp;COMMIT;</code></div><div class="line number2 index1 alt1"><code class="xml plain">Query&nbsp;OK,&nbsp;0&nbsp;rows&nbsp;affected&nbsp;(0.01&nbsp;sec)</code></div></div></td></tr></tbody></table>
        </div>
        <p>再使用客户端2查看一下结果</p>
        <div id="highlighter_722070" class="syntaxhighlighter  xml"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="xml plain">mysql&gt;&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;my_class;</code></div><div class="line number2 index1 alt1"><code class="xml plain">+----------+------------+</code></div><div class="line number3 index2 alt2"><code class="xml plain">|&nbsp;class_id&nbsp;|&nbsp;class_name&nbsp;|</code></div><div class="line number4 index3 alt1"><code class="xml plain">+----------+------------+</code></div><div class="line number5 index4 alt2"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;|&nbsp;1班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number6 index5 alt1"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;|&nbsp;2班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number7 index6 alt2"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3&nbsp;|&nbsp;3班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number8 index7 alt1"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4&nbsp;|&nbsp;4班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number9 index8 alt2"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5&nbsp;|&nbsp;5班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number10 index9 alt1"><code class="xml plain">+----------+------------+</code></div><div class="line number11 index10 alt2"><code class="xml plain">5&nbsp;rows&nbsp;in&nbsp;set&nbsp;(0.00&nbsp;sec)</code></div></div></td></tr></tbody></table>
        </div>
        <p>这就证明客户端1提交事务后，操作就同步到了数据库表中，客户端2因此查看到了客户端1的操作</p>

        <p><em>通常我们不会关闭自动事务</em>，因为这样操作太麻烦。我们只会在需要使用事务处理（手动事务）的时候，才会进行操作</p>
        <hr>
        <h2>手动事务</h2>
        <p><em>手动事务</em>：不管是开始、过程还是结束都需要用户（程序员）手动的发送事务操作指令来实现</p>
        <p>手动事务对应的命令：</p>
        <ol>
            <li>开启事务：start transaction，从这条语句开始，后面的所有语句都不会直接写入到数据表（会保存在事务日志中）</li>
            <li>事务处理：多个写指令构成</li>
            <li>事务提交：commit/rollback，到这个时候所有的事务才算结束</li>
        </ol>
        <h3>开启事务</h3>
        <div id="highlighter_231580" class="syntaxhighlighter  xml"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="xml plain">mysql&gt;&nbsp;start&nbsp;transaction;</code></div><div class="line number2 index1 alt1"><code class="xml plain">Query&nbsp;OK,&nbsp;0&nbsp;rows&nbsp;affected&nbsp;(0.00&nbsp;sec)</code></div></div></td></tr></tbody></table>
        </div>
        <h3>执行事务</h3>
        <p>将多个连续的但是是一个整体的SQL指令，逐一执行</p>
        <p>此时你对数据库表进行的写操作都会保存在事务日志中，不会对表产生影响，等到提交事务后，才会让所有的-- SQL语句对数据库表产生影响</p>
        <h3>提交事务</h3>
        <p>
            提交：commit（将事务从事务日志中同步到数据表，操作后该事务会被清空）
            <br>回滚：rollback（直接清空该事务，之前的操作不要了）
        </p>

        <div id="highlighter_52038" class="syntaxhighlighter  xml"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="xml plain">mysql&gt;&nbsp;commit;</code></div><div class="line number2 index1 alt1"><code class="xml plain">Query&nbsp;OK,&nbsp;0&nbsp;rows&nbsp;affected&nbsp;(0.00&nbsp;sec)</code></div></div></td></tr></tbody></table>
        </div>
        <h3>回滚点</h3>
        <p><em>回滚点</em>：savepoint，当有一系列事务操作时，而其中的步骤如果成功了，可以在这个点设置一个记号（回滚点），然后如果后面的步骤有失误，没有必要重新来过，可以通过rollback命令回到这个记号位置</p>
        <p>增加回滚点：savepoint 回滚点名字; &nbsp;&nbsp;&nbsp;//字母数字和下划线构成。</p>
        <p>回到回滚点：rolback to 回滚点名字; &nbsp;&nbsp;&nbsp;//那个记号（回滚点）之后的所有操作没有了</p>
        <p><em>注意</em>：在一个事务处理中，如果有很多个步骤，那么可以设置多个回滚点。但是如果回到了前面的回滚点，后面的回滚点会失效</p>

        <p>示例</p>
        <div id="highlighter_624225" class="syntaxhighlighter  xml"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div><div class="line number47 index46 alt2">47</div><div class="line number48 index47 alt1">48</div><div class="line number49 index48 alt2">49</div><div class="line number50 index49 alt1">50</div><div class="line number51 index50 alt2">51</div><div class="line number52 index51 alt1">52</div><div class="line number53 index52 alt2">53</div><div class="line number54 index53 alt1">54</div><div class="line number55 index54 alt2">55</div><div class="line number56 index55 alt1">56</div><div class="line number57 index56 alt2">57</div><div class="line number58 index57 alt1">58</div><div class="line number59 index58 alt2">59</div><div class="line number60 index59 alt1">60</div><div class="line number61 index60 alt2">61</div><div class="line number62 index61 alt1">62</div><div class="line number63 index62 alt2">63</div><div class="line number64 index63 alt1">64</div><div class="line number65 index64 alt2">65</div><div class="line number66 index65 alt1">66</div><div class="line number67 index66 alt2">67</div><div class="line number68 index67 alt1">68</div><div class="line number69 index68 alt2">69</div><div class="line number70 index69 alt1">70</div><div class="line number71 index70 alt2">71</div><div class="line number72 index71 alt1">72</div><div class="line number73 index72 alt2">73</div><div class="line number74 index73 alt1">74</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="xml plain">mysql&gt;&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;my_class;</code></div><div class="line number2 index1 alt1"><code class="xml plain">+----------+------------+</code></div><div class="line number3 index2 alt2"><code class="xml plain">|&nbsp;class_id&nbsp;|&nbsp;class_name&nbsp;|</code></div><div class="line number4 index3 alt1"><code class="xml plain">+----------+------------+</code></div><div class="line number5 index4 alt2"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;|&nbsp;1班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number6 index5 alt1"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;|&nbsp;2班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number7 index6 alt2"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3&nbsp;|&nbsp;3班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number8 index7 alt1"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4&nbsp;|&nbsp;4班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number9 index8 alt2"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5&nbsp;|&nbsp;5班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number10 index9 alt1"><code class="xml plain">+----------+------------+</code></div><div class="line number11 index10 alt2"><code class="xml plain">5&nbsp;rows&nbsp;in&nbsp;set&nbsp;(0.00&nbsp;sec)</code></div><div class="line number12 index11 alt1">&nbsp;</div><div class="line number13 index12 alt2"><code class="xml plain">mysql&gt;&nbsp;--&nbsp;开启事务</code></div><div class="line number14 index13 alt1"><code class="xml plain">mysql&gt;&nbsp;start&nbsp;transaction;</code></div><div class="line number15 index14 alt2"><code class="xml plain">Query&nbsp;OK,&nbsp;0&nbsp;rows&nbsp;affected&nbsp;(0.00&nbsp;sec)</code></div><div class="line number16 index15 alt1">&nbsp;</div><div class="line number17 index16 alt2"><code class="xml plain">mysql&gt;&nbsp;INSERT&nbsp;INTO&nbsp;my_class&nbsp;VALUES(6,'6班');</code></div><div class="line number18 index17 alt1"><code class="xml plain">Query&nbsp;OK,&nbsp;1&nbsp;row&nbsp;affected&nbsp;(0.03&nbsp;sec)</code></div><div class="line number19 index18 alt2">&nbsp;</div><div class="line number20 index19 alt1"><code class="xml plain">mysql&gt;&nbsp;--&nbsp;设置回滚点</code></div><div class="line number21 index20 alt2"><code class="xml plain">mysql&gt;&nbsp;savepoint&nbsp;sp1;</code></div><div class="line number22 index21 alt1"><code class="xml plain">Query&nbsp;OK,&nbsp;0&nbsp;rows&nbsp;affected&nbsp;(0.01&nbsp;sec)</code></div><div class="line number23 index22 alt2">&nbsp;</div><div class="line number24 index23 alt1"><code class="xml plain">mysql&gt;&nbsp;--&nbsp;操作失误点</code></div><div class="line number25 index24 alt2"><code class="xml plain">mysql&gt;&nbsp;INSERT&nbsp;INTO&nbsp;my_class&nbsp;VALUES(70,'70班');</code></div><div class="line number26 index25 alt1"><code class="xml plain">Query&nbsp;OK,&nbsp;1&nbsp;row&nbsp;affected&nbsp;(0.00&nbsp;sec)</code></div><div class="line number27 index26 alt2">&nbsp;</div><div class="line number28 index27 alt1"><code class="xml plain">mysql&gt;&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;my_class;</code></div><div class="line number29 index28 alt2"><code class="xml plain">+----------+------------+</code></div><div class="line number30 index29 alt1"><code class="xml plain">|&nbsp;class_id&nbsp;|&nbsp;class_name&nbsp;|</code></div><div class="line number31 index30 alt2"><code class="xml plain">+----------+------------+</code></div><div class="line number32 index31 alt1"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;|&nbsp;1班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number33 index32 alt2"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;|&nbsp;2班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number34 index33 alt1"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3&nbsp;|&nbsp;3班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number35 index34 alt2"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4&nbsp;|&nbsp;4班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number36 index35 alt1"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5&nbsp;|&nbsp;5班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number37 index36 alt2"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6&nbsp;|&nbsp;6班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number38 index37 alt1"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;70&nbsp;|&nbsp;70班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number39 index38 alt2"><code class="xml plain">+----------+------------+</code></div><div class="line number40 index39 alt1"><code class="xml plain">7&nbsp;rows&nbsp;in&nbsp;set&nbsp;(0.00&nbsp;sec)</code></div><div class="line number41 index40 alt2">&nbsp;</div><div class="line number42 index41 alt1"><code class="xml plain">mysql&gt;&nbsp;--&nbsp;回到上个回滚点</code></div><div class="line number43 index42 alt2"><code class="xml plain">mysql&gt;&nbsp;rollback&nbsp;to&nbsp;sp1;</code></div><div class="line number44 index43 alt1"><code class="xml plain">Query&nbsp;OK,&nbsp;0&nbsp;rows&nbsp;affected&nbsp;(0.09&nbsp;sec)</code></div><div class="line number45 index44 alt2">&nbsp;</div><div class="line number46 index45 alt1"><code class="xml plain">mysql&gt;&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;my_class;</code></div><div class="line number47 index46 alt2"><code class="xml plain">+----------+------------+</code></div><div class="line number48 index47 alt1"><code class="xml plain">|&nbsp;class_id&nbsp;|&nbsp;class_name&nbsp;|</code></div><div class="line number49 index48 alt2"><code class="xml plain">+----------+------------+</code></div><div class="line number50 index49 alt1"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;|&nbsp;1班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number51 index50 alt2"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;|&nbsp;2班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number52 index51 alt1"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3&nbsp;|&nbsp;3班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number53 index52 alt2"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4&nbsp;|&nbsp;4班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number54 index53 alt1"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5&nbsp;|&nbsp;5班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number55 index54 alt2"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6&nbsp;|&nbsp;6班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number56 index55 alt1"><code class="xml plain">+----------+------------+</code></div><div class="line number57 index56 alt2"><code class="xml plain">6&nbsp;rows&nbsp;in&nbsp;set&nbsp;(0.00&nbsp;sec)</code></div><div class="line number58 index57 alt1">&nbsp;</div><div class="line number59 index58 alt2"><code class="xml plain">mysql&gt;&nbsp;--&nbsp;提交事务</code></div><div class="line number60 index59 alt1"><code class="xml plain">mysql&gt;&nbsp;commit;</code></div><div class="line number61 index60 alt2"><code class="xml plain">Query&nbsp;OK,&nbsp;0&nbsp;rows&nbsp;affected&nbsp;(0.01&nbsp;sec)</code></div><div class="line number62 index61 alt1">&nbsp;</div><div class="line number63 index62 alt2"><code class="xml plain">mysql&gt;&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;my_class;</code></div><div class="line number64 index63 alt1"><code class="xml plain">+----------+------------+</code></div><div class="line number65 index64 alt2"><code class="xml plain">|&nbsp;class_id&nbsp;|&nbsp;class_name&nbsp;|</code></div><div class="line number66 index65 alt1"><code class="xml plain">+----------+------------+</code></div><div class="line number67 index66 alt2"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;|&nbsp;1班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number68 index67 alt1"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;|&nbsp;2班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number69 index68 alt2"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3&nbsp;|&nbsp;3班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number70 index69 alt1"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4&nbsp;|&nbsp;4班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number71 index70 alt2"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5&nbsp;|&nbsp;5班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number72 index71 alt1"><code class="xml plain">|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6&nbsp;|&nbsp;6班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</code></div><div class="line number73 index72 alt2"><code class="xml plain">+----------+------------+</code></div><div class="line number74 index73 alt1"><code class="xml plain">6&nbsp;rows&nbsp;in&nbsp;set&nbsp;(0.00&nbsp;sec)</code></div></div></td></tr></tbody></table>
        </div>






    </div>
</article>
<footer></footer>
</body>
</html>
